# 実装計画

- [x] 1. プロジェクト基盤とインフラストラクチャのセットアップ (venv環境)
  - Python 3.10+ プロジェクトを初期化し、必要な依存関係を管理する
  - 依存関係管理ファイル（requirements.txt）を作成し、google-genai、mcp、textual、python-dotenv を追加する
  - .gitignore ファイルを作成し、.env、__pycache__、*.pyc を除外する
  - .env.example テンプレートを作成し、必要な環境変数の例を提供する
  - ログ設定を初期化し、app.log にエラーと警告を記録する
  - _Requirements: すべての要件に基盤セットアップが必要_

- [x] 2. 設定管理機能の実装
- [x] 2.1 環境変数読み込みと検証機能を構築
  - 環境変数から設定を読み込む機能を実装する
  - Gemini API キーの必須検証ロジックを実装する
  - MCP サーバー設定のオプショナル読み込み機能を実装する
  - 設定検証エラーを適切に処理し、ユーザーフレンドリーなメッセージを返す
  - _Requirements: 4.1, 4.2, 4.3, 4.4_

- [x] 3. エラーハンドリングシステムの実装
- [x] 3.1 エラー分類とロギング機能を構築
  - エラーカテゴリ（ネットワーク、レート制限、認証、MCP 接続、未知）を定義する
  - 各エラータイプに対するユーザーメッセージ生成機能を実装する
  - エラーログ記録機能を実装し、ログレベルを適切に設定する
  - エラーの回復可能性を判定する機能を実装する
  - _Requirements: 5.1, 5.2, 5.3, 5.4_

- [x] 4. Gemini API クライアントの実装
- [x] 4.1 Gemini API との基本通信機能を構築
  - google-genai SDK を使用した Gemini クライアント初期化機能を実装する
  - API キーを使用した認証機能を実装する
  - モデル設定（gemini-1.5-flash）を適用する
  - _Requirements: 1.1, 1.2_

- [x] 4.2 メッセージ送信と応答受信機能を実装
  - ユーザーメッセージを Gemini API に送信する非同期機能を実装する
  - オプショナルな MCP コンテキスト情報をメッセージに含める機能を実装する
  - Gemini API からの応答を受信して返す機能を実装する
  - 会話履歴を管理する機能を実装する
  - _Requirements: 1.3, 1.4_

- [x] 4.3 Gemini API エラーハンドリングを実装
  - ネットワークエラーを検出して GeminiError として処理する
  - レート制限エラー（HTTP 429）を検出して適切に処理する
  - 認証エラー（HTTP 401/403）を検出して処理する
  - その他の API エラーを汎用エラーとして処理する
  - _Requirements: 1.5_

- [x] 5. MCP クライアントの実装
- [x] 5.1 MCP サーバー接続機能を構築
  - mcp Python SDK を使用した MCP クライアント初期化機能を実装する
  - stdio トランスポートを使用した MCP サーバー接続機能を実装する
  - 接続成功・失敗を判定する機能を実装する
  - 接続状態を確認する機能を実装する
  - _Requirements: 2.1, 2.2_

- [x] 5.2 MCP コンテキスト取得機能を実装
  - MCP サーバーからコンテキスト情報を取得する非同期機能を実装する
  - コンテキスト取得失敗時の処理を実装する
  - コンテキスト情報を文字列形式で返す機能を実装する
  - _Requirements: 2.5_

- [x] 5.3 MCP エラーハンドリングとオプショナル動作を実装
  - MCP 接続エラーを検出して MCPError として処理する
  - MCP 接続失敗時にアプリケーションを継続する機能を実装する
  - MCP サーバー切断機能を実装する
  - _Requirements: 2.4_

- [ ] 6. ターミナルチャット UI の実装
- [ ] 6.1 基本的なチャット UI レイアウトを構築
  - Textual Framework を使用したアプリケーションエントリーポイントを作成する
  - タイトル表示エリアを実装する
  - MCP 接続状態表示エリアを実装する
  - メッセージ履歴表示エリアを実装する
  - メッセージ入力フィールドを実装する
  - キーバインド表示フッターを実装する
  - _Requirements: 3.1, 3.2, 3.3_

- [ ] 6.2 ユーザーインタラクション機能を実装
  - ユーザーメッセージ入力イベントハンドラーを実装する
  - 入力メッセージを履歴エリアに追加する機能を実装する
  - メッセージ送信時にアプリケーション層のコールバックを呼び出す
  - _Requirements: 3.4_

- [ ] 6.3 AI 応答表示とローディング機能を実装
  - AI からの応答を履歴エリアに追加する機能を実装する
  - ローディングインジケーターを表示・非表示にする機能を実装する
  - MCP 接続状態を動的に更新する機能を実装する
  - _Requirements: 3.5, 3.6, 2.3_

- [x] 7. アプリケーション層の統合
- [x] 7.1 アプリケーションライフサイクル管理を実装
  - アプリケーション初期化機能を実装し、設定を読み込む
  - Gemini クライアントを初期化する機能を実装する
  - MCP クライアントをオプショナルに初期化する機能を実装する
  - アプリケーション終了時のクリーンアップ機能を実装する
  - _Requirements: 1.1, 1.2, 2.1, 2.2_

- [x] 7.2 メッセージ処理フローを統合
  - ユーザーメッセージを受け取る機能を実装する
  - MCP クライアントが接続されている場合にコンテキスト情報を取得する
  - Gemini クライアントにメッセージとコンテキストを送信する
  - エラーハンドラーを使用してエラーを処理する
  - 応答を UI に返す機能を実装する
  - _Requirements: 1.3, 1.4, 1.5, 2.5, 5.1, 5.2, 5.3, 5.4_

- [ ] 7.3 チャット UI とアプリケーション層を接続
  - チャット UI を初期化し、メッセージ処理コールバックを設定する
  - MCP 接続状態を UI に反映する
  - エラーメッセージを UI に表示する機能を実装する
  - アプリケーションを起動してチャット UI を実行する
  - _Requirements: 3.1, 3.2, 3.3, 3.4, 3.5, 3.6, 2.3_

- [x] 8. エントリーポイントとプロジェクト完成
- [x] 8.1 メインエントリーポイントを作成
  - main.py ファイルを作成し、アプリケーションを起動する
  - コマンドライン引数処理を実装する（オプショナル）
  - 致命的なエラー時の適切な終了処理を実装する
  - _Requirements: すべての要件_

- [x] 8.2 ドキュメントとサンプル設定を整備
  - README.md を作成し、インストール手順と使用方法を記述する
  - .env.example に実際の設定例を追加する
  - 依存関係のバージョンを requirements.txt に固定する
  - _Requirements: 4.4（設定管理のユーザビリティ）_

- [ ] 9. テストの実装
- [ ] 9.1 ユニットテストを実装
  - ConfigurationManager のテストを作成する
  - ErrorHandler のテストを作成する
  - GeminiClient のテスト（モックを使用）を作成する
  - MCPClient のテスト（モックを使用）を作成する
  - Message データモデルのテストを作成する
  - _Requirements: すべての要件（品質保証）_

- [ ] 9.2 統合テストを実装
  - Application ⇔ GeminiClient の統合テストを作成する
  - Application ⇔ MCPClient の統合テストを作成する
  - ChatUI ⇔ Application の統合テストを作成する
  - _Requirements: すべての要件（統合動作の検証）_

- [ ] 9.3 E2E テストを実装
  - 正常系チャットフローのテストを作成する
  - MCP 統合フローのテストを作成する
  - エラーリカバリーフローのテストを作成する
  - 設定エラーフローのテストを作成する
  - MCP オプショナルフローのテストを作成する
  - _Requirements: すべての要件（エンドツーエンド動作の検証）_